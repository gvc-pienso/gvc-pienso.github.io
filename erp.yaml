openapi: 3.2.0
jsonSchemaDialect: https://spec.openapis.org/oas/3.1/dialect/base
info:
  title: API Servicios ERP para sistemas de fábrica
  description: |
    Detalle de los servicios proporcionados por el software del ERP que son llamadas desde sistemas externos como sistemas de fábrica
    para guardar información en el ERP. También se ofrecen servicios de consulta para poder consultar desde sistemas externos información de fábrica
    almacenada en el ERP.
  version: 1.0.0

servers:
  - url: https://server.erp.com

tags:
  - name: Recepciones
    description: Servicios de recepciones de materia prima
  - name: Expediciones
    description: Servicios de expediciones de pienso
  - name: Regularizaciones
    description: Servicios de Regularizaciones
  - name: Producciones
    description: Servicios de Producciones

paths:
  /recepciones:
    post:
      tags: [Recepciones]
      summary: Crear o registrar recepciones de materia prima
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Recepciones"
            example:
              recepciones:
                mensajeId: "4d9a1c30-6a2e-4a6c-9f3b-6b12c3d4e5f6"
                fechaCreacion: "2025-07-09T10:15+02:00"
                origen: "VC Lleida"
                recepciones:
                  - idViaje: "VJ-2025-000123"
                    codigoExterno: "ERP-REC-784512"
                    estado: "C"
                    matriculaVehiculo: "1234-ABC"
                    matriculaRemolque: "5678-DEF"
                    operadorTransporte: "OP-TRAN-07"
                    agenciaTransporte: "AG-LOG-21"
                    conductor: "COND-00987"
                    nifConductor: "12345678Z"
                    nombreConductor: "Carlos Martínez"
                    fechaEntrada: "2025-07-09T08:30+02:00"
                    pesoEntrada: 28450.75
                    fechaSalida: "2025-07-09T11:10+02:00"
                    pesoSalida: 14520.30
                    lineas:
                      - id: "954"
                        producto: "ALM-00045"
                        cantidadTeorica: 12000.0
                        unidadCantidadTeorica: "kg"
                        cantidadReal: 11850.5
                        unidadCantidadReal: "kg"
                        proveedor: "PRV-00321"
                        aplicacion: "AC-2025-017"
                        loteProveedor: "LP-789654"
                        loteFabrica: "LF-20250709-01"
                        fechaCaducidadLote: "2026-01-15T00:00+02:00"
                        codigoMuestra: "QM-2025-001"
                        referenciaProveedor: "ALB-PRV-556677"
                        referenciaSistemaFabrica: "ALB-SF-998877"
                        codigoRechazo: null
                        observacionesAnomalia: "Sin incidencias"
                        certificadoDesinfeccion: "CD-2025-0001"
                        calidad:
                          - codigoCalidad: 101
                            valor: 8.7
                          - codigoCalidad: 205
                            valor: 12.3
                      - id: "L-002"
                        producto: "ALM-00078"
                        cantidadTeorica: 7000.0
                        unidadCantidadTeorica: "kg"
                        cantidadReal: 6950.0
                        unidadCantidadReal: "kg"
                        proveedor: "PRV-00456"
                        aplicacion: "AC-2025-018"
                        loteProveedor: "LP-456123"
                        loteFabrica: "LF-20250709-02"
                        fechaCaducidadLote: "2025-12-31T00:00+02:00"
                        codigoMuestra: "QM-2025-002"
                        referenciaProveedor: "ALB-PRV-112233"
                        referenciaSistemaFabrica: "ALB-SF-665544"
                        codigoRechazo: null
                        observacionesAnomalia: ""
                        certificadoDesinfeccion: "CD-2025-0002"
                        calidad:
                          - codigoCalidad: 101
                            valor: 9.1
      responses:
        "200":
          description: Recepción procesada correctamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: array
                    items:
                      type: string
                    example:
                      - Se ha guardado correctamente.
                  code:
                    type: string
                    description: |
                      Resultado de servicio:
                      OK - Resultado correcto
                      NOK - Resultado incorrecto
        "400":
          description: Solicitud incorrecta (errores de validación o formato)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Solicitud incorrecta (errores de validación o formato)"
        "500":
          description: Error interno del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Error interno del servidor"

  /expediciones:
    post:
      tags: [Expediciones]
      summary: Obtener en el erp expediciones de pienso realizardas desde fábrica
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Expediciones"
            example:
              expediciones:
                mensajeId: "8aa1e2b4-2a4b-4d29-9d56-112233445566"
                fechaCreacion: "2025-07-09T10:15+02:00"
                origen: "VC Lleida"
                expediciones:
                  - idViaje: "EXP-001"
                    codigoExterno: "ERP-EXP-001"
                    fechaPrevista: "2025-07-10T06:00+02:00"
                    fechaRealizacion: "2025-07-10T06:30+02:00"
                    conductor: "1213"
                    nifConductor: "7893515-Q"
                    nombreConductor: "Fernando Sanchez"
                    matriculaRemolque: "9999-ZZZ"
                    matriculaVehiculo: "8888-YYY"
                    operadorTransporte: "OP-TRAN-07"
                    agenciaTransporte: "AG-LOG-21"
                    pesoEntrada: 12000.0
                    unidadPesoEntrada: "Kg"
                    fechaPesoEntrada: "2025-07-10T06:10+02:00"
                    estado: "C"
                    lineas:
                      - producto: "PROD-001"
                        cliente: "CLI-001"
                        explotacion: "EXPLO-001"
                        pedido: "PED-2025-0001"
                        pedidoLinea: "1"
                        fechaEntrega: "2025-07-10T12:00+02:00"
                        fechaRealizacion: "2025-07-10T06:30+02:00"
                        cantidades:
                          - id: 101
                            codigoLote: "L-PROD-0001"
                            cantidad: 2500.0
                            unidad: "kg"
                          - id: 102
                            codigoLote: "L-PROD-0002"
                            cantidad: 500.0
                            unidad: "kg"
      responses:
        "200":
          description: Expediciones recibidas correctamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: array
                    items:
                      type: string
                    example:
                      - Expediciones procesadas correctamente
        "400":
          description: Solicitud incorrecta (errores de validación o formato)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Solicitud incorrecta (errores de validación o formato)"
        "500":
          description: Error interno del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Error interno del servidor"

  /regularizaciones:
    post:
      tags: [Regularizaciones]
      summary: guardar en el erp regularizaciones de pienso o materia prima realizardas desde fábrica
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Regularizaciones"
            example:
              regularizaciones:
                mensajeId: "123e4567-e89b-12d3-a456-426614174000"
                fechaCreacion: "2025-07-09T10:15+02:00"
                origen: "VC Lleida"
                regularizaciones:
                  - id: 1
                    producto: "MAT-001"
                    cantidad: 100.5
                    unidad: "kg"
                    fecha: "2025-07-09T09:00+02:00"
                    loteFabrica: "LF-001"
                  - id: 2
                    producto: "PROD-001"
                    cantidad: -50.0
                    unidad: "kg"
                    fecha: "2025-07-09T09:30+02:00"
                    loteFabrica: "LF-PROD-001"
      responses:
        "200":
          description: regularizaciones recibidas correctamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: array
                    items:
                      type: string
                    example:
                      - Regularizaciones procesadas correctamente
        "400":
          description: Solicitud incorrecta (errores de validación o formato)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Solicitud incorrecta (errores de validación o formato)"
        "500":
          description: Error interno del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Error interno del servidor"

  /producciones:
    post:
      tags: [Producciones]
      summary: guardar en el erp producciones (con sus consumos) de pienso realizadas desde fábrica
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Producciones"
            example:
              producciones:
                mensajeId: "550e8400-e29b-41d4-a716-446655440000"
                fechaCreacion: "2025-07-09T10:15+02:00"
                origen: "VC Lleida"
                fabricaciones:
                  - fechaProduccion: "2025-07-09T10:15+02:00"
                    identificadorProduccion: "FAB-001"
                    versionFormula: "20777"
                    movimientos:
                      consumidos:
                        - codigoProducto: "MAT-001"
                          identificadorProduccion: "FAB-001"
                          cantidad: 1000.5
                          unidad: "kg"
                          loteRecepcion: "L001-PRV"
                          loteFabrica: "LF-1001"
                        - codigoProducto: "MAT-002"
                          identificadorProduccion: "FAB-001"
                          cantidad: 500.0
                          unidad: "kg"
                          loteRecepcion: "L002-PRV"
                          loteFabrica: "LF-1002"
                      producidos:
                        - codigoProducto: "PROD-001"
                          identificadorProduccion: "FAB-001"
                          cantidad: 1450.5
                          unidad: "kg"
                          loteFabricacion: "LF-PROD-001"
                          fechaCaducidad: "2026-01-09T00:00+02:00"
                  - fechaProduccion: "2025-07-10T08:00+02:00"
                    identificadorProduccion: "FAB-002"
                    versionFormula: "20076"
                    movimientos:
                      consumidos:
                        - codigoProducto: "MAT-003"
                          identificadorProduccion: "FAB-002"
                          cantidad: 800.0
                          unidad: "kg"
                          loteRecepcion: "L003-PRV"
                          loteFabrica: "LF-2001"
                      producidos:
                        - codigoProducto: "PROD-002"
                          identificadorProduccion: "FAB-002"
                          cantidad: 790.0
                          unidad: "kg"
                          loteFabricacion: "LF-PROD-002"
                          fechaCaducidad: "2026-01-10T00:00+02:00"
      responses:
        "200":
          description: Producciones recibidas correctamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Producciones procesadas correctamente"
        "400":
          description: Solicitud incorrecta (errores de validación o formato)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Solicitud incorrecta (errores de validación o formato)"
        "500":
          description: Error interno del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Error interno del servidor"

components:
  schemas:
    EnvelopeRecepciones:
      type: object
      required: [recepciones]
      additionalProperties: false
      properties:
        recepciones:
          $ref: "#/components/schemas/Recepciones"

    Recepciones:
      type: object
      required: [mensajeId, fechaCreacion, origen, recepciones]
      properties:
        mensajeId:
          type: string
          format: uuid
          description: Identificador del mensaje
        fechaCreacion:
          type: string
          format: date-time
          description: Fecha de creación en formato ISO 8601 con franja horaria
          example: "2025-07-09T10:15+02:00"
        origen:
          type: string
          description: Identificador del origen - Identificador de la fábrica en el ERP
          example: "VC Lleida"
        recepciones:
          type: array
          items:
            type: object
            required: [idViaje, codigoExterno, estado, matriculaRemolque, fechaEntrada, lineas]
            properties:
              idViaje:
                type: string
                description: Número de identificación interna del viaje del Sistema de fábrica
              codigoExterno:
                type: string
                description: Identificador de la recepción del ERP (referencia transportista)
              estado:
                type: string
                description: |
                  Estado de la recepcion:
                  R - Recepción rechazada
                  C - Recepción realizada
              matriculaVehiculo:
                type: string
              matriculaRemolque:
                type: string
              operadorTransporte:
                type: string
                description: codigo del operador que ha hecho la recepción
              agenciaTransporte:
                type: string
                description: Codigo de la agencia intermediaria del transporte.
              conductor:
                type: string
                description: Identificador en el ERP del conductor.
              nifConductor:
                type: string
                description: nif del conductor
              nombreConductor:
                type: string
                description: Nombre del conductor
              fechaEntrada:
                type: string
                format: date-time
                description: Fecha de entrada de la recepción a fábrica en formato ISO 8601 con franja horaria
                example: "2025-07-09T10:15+02:00"
              pesoEntrada:
                type: number
                format: double
                description: Peso de entrada del camión en fábrica
              fechaSalida:
                type: string
                format: date-time
                description: Fecha de salida del camión de fábrica en formato ISO 8601 con franja horaria
                example: "2025-07-09T10:15+02:00"
              pesoSalida:
                type: number
                format: double
                description: Peso de salida del camión en fábrica
              codigoRechazo:
                type: string
                description: en caso de estado R (Rechazado), especifica el motivo
              lineas:
                type: array
                items:
                  type: object
                  required: [id, producto, cantidadTeorica, cantidadReal]
                  properties:
                    id:
                      type: integer
                      description: Identificador de la linea
                    producto:
                      type: string
                      description: Identificador del artículo a recepcionar
                    cantidadTeorica:
                      type: number
                      format: double
                      description: Cantidad teorica en la recepción. Peso en origen
                    unidadCantidadTeorica:
                      type: string
                      description: Unidad de la cantidad teorica
                    cantidadReal:
                      type: number
                      format: double
                      description: Cantidad real de la recepción que ha entrado en el sistema
                    unidadCantidadReal:
                      type: string
                      description: Unidad de la cantidad real
                    proveedor:
                      type: string
                      description: Código del proveedor.
                    aplicacion:
                      type: string
                      description: Código del acuerdo de compra de fábrica.
                    loteProveedor:
                      type: string
                      description: Identificador del lote del proveedor.
                    loteFabrica:
                      type: string
                      description: Identificador del lote de fábrica para la línea.
                    fechaCaducidadLote:
                      type: string
                      format: date-time
                      description: Fecha caducidad lote.
                      example: "2025-07-09T10:15+02:00"
                    codigoMuestra:
                      type: string
                      description: Código de muestra
                    referenciaProveedor:
                      type: string
                      description: referencia del proveedor. Albarán del proveedor.
                    referenciaSistemaFabrica:
                      type: string
                      description: referencia del Sistema de fábrica. Albarán del sitema de fábrica.
                    codigoRechazo:
                      type: string
                      description: Código de rechazo de la línia de la recepción de mmpp
                    observacionesAnomalia:
                      type: string
                      description: Texto libre para observaciones de fábrica
                    certificadoDesinfeccion:
                      type: string
                      description: Identificador del certificado de desinfección del vehículo
                    calidad:
                      type: array
                      items:
                        type: object
                        properties:
                          codigoCalidad:
                            type: integer
                            description: identificador del codigo de calidad
                          valor:
                            type: number
                            format: double
                            description: Valor de calidad

    EnvelopeExpediciones:
      type: object
      required: [expediciones]
      additionalProperties: false
      properties:
        expediciones:
          $ref: "#/components/schemas/Expediciones"

    Expediciones:
      type: object
      required: [mensajeId, fechaCreacion, origen, expediciones]
      properties:
        mensajeId:
          type: string
          format: uuid
          description: Identificador del mensaje
        fechaCreacion:
          type: string
          format: date-time
          description: Fecha de creación en formato ISO 8601 con franja horaria
          example: "2025-07-09T10:15+02:00"
        origen:
          type: string
          description: Identificador del origen - Identificador de la fábrica en el ERP
          example: "VC Lleida"
        expediciones:
          type: array
          items:
            type: object
            required: [idViaje, codigoExterno, fechaRealizacion, matriculaRemolque, estado, lineas]
            properties:
              idViaje:
                type: string
                description: Identificador del sistema de fábrica de la expedición
              codigoExterno:
                type: string
                description: identificador de la expedición en el ERP
              fechaPrevista:
                type: string
                format: date-time
                description: fecha prevista en formato ISO 8601 con franja horaria
                example: "2025-07-09T10:15+02:00"
              fechaRealizacion:
                type: string
                format: date-time
                description: Fecha de realización de la expedición
                example: "2025-07-09T10:15+02:00"
              matriculaRemolque:
                type: string
                description: matrícula del remolque
              matriculaVehiculo:
                type: string
                description: matrícula del vehículo
              conductor:
                type: string
                description: identificador interno del conductor
              nifConductor:
                type: string
                description: nif del conductor
              nombreConductor:
                type: string
                description: Nombre del conductor
              operadorTransporte:
                type: string
                description: Codigo operador transportista en el erp
              agenciaTransporte:
                type: string
                description: Codigo agencia transportista en el erp
              pesoEntrada:
                type: number
                format: double
                description: Peso entrada del vehículo
              unidadPesoEntrada:
                type: string
                description: Unidad de la cantidad de peso entrada.
              fechaPesoEntrada:
                type: string
                format: date-time
                description: fecha cuando se hace la pesada de entrada en formato ISO 8601 con franja horaria
                example: "2025-07-09T10:15+02:00"
              estado:
                type: string
                description: |
                  El estado de la expedición:
                  E - Expedición en edición
                  P - Expedición pendiente de expedir
                  T - Expedición en tránsito (Pendiente de la confirmación del camionero de la entrega)
                  C - Expedición cerrada
                  R - Expedición rechazar
              lineas:
                type: array
                items:
                  type: object
                  required: [producto, cantidades]
                  properties:
                    producto:
                      type: string
                      description: Identificador del artículo de pienso expedido
                    cliente:
                      type: string
                      description: Código del cliente a expedir el pienso
                    explotacion:
                      type: string
                      description: Identificador de la explotación (Código de granja)
                    pedido:
                      type: string
                      description: Identificador del pedido del erp
                    pedidoLinea:
                      type: string
                      description: Identificador del pedido del erp (línea)
                    fechaEntrega:
                      type: string
                      format: date-time
                      description: fecha de entrega en formato ISO 8601 con franja horaria
                      example: "2025-07-09T10:15+02:00"
                    fechaRealizacion:
                      type: string
                      format: date-time
                      description: fecha de realización en formato ISO 8601 con franja horaria
                      example: "2025-07-09T10:15+02:00"
                    cantidades:
                      type: array
                      items:
                        type: object
                        required: [id, cantidad, unidad]
                        properties:
                          id:
                            type: integer
                            description: Identificador interno del sistema de fábrica del lote.
                          codigoLote:
                            type: string
                            description: Identificador del lote fabricación
                          cantidad:
                            type: number
                            format: double
                            description: Cantidad del lote
                          unidad:
                            type: string
                            description: Unidad de la cantidad

    EnvelopeRegularizaciones:
      type: object
      required: [regularizaciones]
      additionalProperties: false
      properties:
        regularizaciones:
          $ref: "#/components/schemas/Regularizaciones"

    Regularizaciones:
      type: object
      required: [mensajeId, fechaCreacion, origen, regularizaciones]
      properties:
        mensajeId:
          type: string
          format: uuid
        fechaCreacion:
          type: string
          format: date-time
          description: Fecha de creación en formato ISO 8601 con franja horaria
          example: "2025-07-09T10:15+02:00"
        origen:
          type: string
          description: Identificador del origen - Identificador de la fábrica en el ERP
          example: "VC Lleida"
        regularizaciones:
          type: array
          items:
            type: object
            required: [id, producto, cantidad, unidad]
            properties:
              id:
                type: integer
                description: identificador interno en el sistema de fábrica
              producto:
                type: string
                description: Identificador del producto
              cantidad:
                type: number
                format: double
                description: Cantidad
              unidad:
                type: string
                description: Unida de la cantidad
              fecha:
                type: string
                format: date-time
                description: Fecha en formato ISO 8601 con franja horaria
                example: "2025-07-09T10:15+02:00"
              loteFabrica:
                type: string
                description: Lote que asigna el sistema de fábrica en la recepción de materia prima o producción de pienso

    EnvelopeProducciones:
      type: object
      required: [producciones]
      additionalProperties: false
      properties:
        producciones:
          $ref: "#/components/schemas/Producciones"

    Producciones:
      type: object
      required: [mensajeId, fechaCreacion, origen, fabricaciones]
      properties:
        mensajeId:
          type: string
          format: uuid
        fechaCreacion:
          type: string
          format: date-time
          description: Fecha de creación en formato ISO 8601 con franja horaria
          example: "2025-07-09T10:15+02:00"
        origen:
          type: string
          description: Identificador del origen - Identificador de la fábrica en el ERP
          example: "VC Lleida"
        fabricaciones:
          type: array
          items:
            type: object
            required: [fechaProduccion, identificadorProduccion]
            properties:
              fechaProduccion:
                type: string
                format: date-time
                description: Fecha de producción en formato ISO 8601 con franja horaria
                example: "2025-07-09T10:15+02:00"
              identificadorProduccion:
                type: string
                description: Identificador interno del sistema de fábrica de la producción. Sirve para vincular consumos y produccciones
              versionFormula:
                type: string
                description: Versión de la fórmula utilizada en la fabricación
              movimientos:
                type: object
                properties:
                  consumidos:
                    type: array
                    items:
                      type: object
                      required: [codigoProducto, identificadorProduccion, cantidad, unidad]
                      properties:
                        codigoProducto:
                          type: string
                          description: Codigo del producto (consumido)
                        identificadorProduccion:
                          type: string
                          description: Identificador de producción (vincula el movimiento a la fabricación)
                        cantidad:
                          type: number
                          format: double
                          description: Cantidad consumida
                        unidad:
                          type: string
                          description: Unidad del artículo
                        loteRecepcion:
                          type: string
                          description: Lote del proveedor de materia prima
                        loteFabrica:
                          type: string
                          description: Lote que asigna el sistema de fábrica en la recepcion de materia prima
                  producidos:
                    type: array
                    items:
                      type: object
                      required: [codigoProducto, identificadorProduccion, cantidad, unidad]
                      properties:
                        codigoProducto:
                          type: string
                          description: Codigo del producto (producido)
                        identificadorProduccion:
                          type: string
                          description: Identificador de producción (vincula el movimiento a la fabricación)
                        cantidad:
                          type: number
                          format: double
                          description: Cantidad producida
                        unidad:
                          type: string
                          description: Unidad del artículo
                        loteFabricacion:
                          type: string
                          description: Lote que asigna el sistema de fábrica en la fabricación de pienso
                        fechaCaducidad:
                          type: string
                          format: date-time
                          description: Fecha de caducidad de Lote que asigna el sistema de fábrica en la fabricación de pienso
                          example: "2025-07-09T10:15+02:00"

  securitySchemes:
    oauth2:
      type: oauth2
      flows:
        clientCredentials:
          tokenUrl: https://login.microsoftonline.com/vallcompanys.es/oauth2/token
          scopes:
            lectura: Permiso de escritura
            escritura: Permiso de lectura

security:
  - oauth2:
      - lectura
      - escritura
